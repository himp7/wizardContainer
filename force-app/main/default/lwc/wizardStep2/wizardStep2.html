<template>
    <lightning-card title="Trigger Selection" icon-name="standard:filter">
        <div class="slds-p-around_medium">

            <!-- Instructions -->
            <div class="slds-m-bottom_medium">
                <p class="slds-text-body_small slds-text-color_weak">
                    Select up to 2 trigger type categories and their corresponding options.
                </p>
            </div>

            <!-- Trigger Type Category Dropdown -->
            <div class="slds-m-bottom_medium">
                <lightning-combobox
                    label="Trigger Type"
                    name="triggerType"
                    placeholder="Select a category"
                    options={triggerTypeOptions}
                    value={selectedCategory}
                    onchange={handleCategoryChange}
                    disabled={isCategoryDropdownDisabled}
                    required>
                </lightning-combobox>
                <template if:true={isCategoryDropdownDisabled}>
                    <p class="slds-text-color_error slds-m-top_x-small">
                        Maximum 2 categories allowed. Remove a category to add another.
                    </p>
                </template>
            </div>

            <!-- Selected Categories Display -->
            <template if:true={hasSelectedCategories}>
                <div class="slds-m-bottom_large">
                    <label class="slds-form-element__label">Selected Categories</label>
                    <div class="category-pills-container slds-m-top_x-small">
                        <template for:each={selectedCategoriesDisplay} for:item="cat">
                            <lightning-pill 
                                key={cat.value}
                                label={cat.label}
                                name={cat.value}
                                onremove={handleCategoryRemove}>
                            </lightning-pill>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Searchable Dropdown for Trigger Options -->
            <template if:true={showOptionsDropdown}>
                <c-searchable-dropdown
                    label="Trigger Options"
                    placeholder="Search options..."
                    options={currentTriggerOptions}
                    selected-values={currentSelectedOptions}
                    onoptionselect={handleOptionSelect}
                    class="slds-m-bottom_medium">
                </c-searchable-dropdown>
                
                <!-- Show pills for currently selected category options -->
                <template if:true={hasCurrentCategorySelections}>
                    <div class="slds-m-top_small slds-m-bottom_medium">
                        <label class="slds-form-element__label slds-text-body_small">
                            Selected for {currentCategoryLabel}:
                        </label>
                        <c-pill-container
                            pills={currentCategoryPills}
                            category={selectedCategory}
                            onpillremove={handlePillRemove}
                            class="slds-m-top_xx-small">
                        </c-pill-container>
                    </div>
                </template>
            </template>

            <!-- All Selected Options as Pills (grouped by category) -->
            <template if:true={hasSelectedOptions}>
                <div class="slds-m-top_large">
                    <div class="slds-border_top slds-p-top_medium">
                        <label class="slds-form-element__label slds-text-heading_small">
                            All Selected Options
                        </label>
                        <template for:each={categoriesWithOptions} for:item="category">
                            <div key={category.name} class="slds-m-top_medium category-section">
                                <div class="slds-text-title slds-text-color_weak slds-m-bottom_x-small">
                                    {category.label}
                                </div>
                                <c-pill-container
                                    pills={category.options}
                                    category={category.name}
                                    onpillremove={handlePillRemove}>
                                </c-pill-container>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Error Message -->
            <template if:true={errorMessage}>
                <div class="slds-m-top_medium">
                    <div class="slds-notify slds-notify_alert slds-alert_error" role="alert">
                        <span class="slds-assistive-text">error</span>
                        <h2>{errorMessage}</h2>
                    </div>
                </div>
            </template>

        </div>

        <!-- Footer Buttons -->
        <div slot="footer" class="slds-clearfix">
            <div class="slds-float_right">
                <lightning-button
                    label="Back"
                    onclick={handleBack}
                    class="slds-m-right_small">
                </lightning-button>
                <lightning-button
                    variant="brand"
                    label="Next"
                    onclick={handleNext}
                    disabled={isNextDisabled}>
                </lightning-button>
            </div>
        </div>

    </lightning-card>
</template>